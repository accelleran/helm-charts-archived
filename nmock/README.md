# Introduction

The NMock tool is used to record and playback all messages that are published on the dRAX NATS Databus and the configuration in Redis. 

Since there are two NATS Databuses, one for 4G and one for 5G, NMock supports switching between which NATS and Redis instance to use for either recording or playback. 

# Version control
Since messages on NATS, and the configuration in Redis can differ from version to version of the dRAX RIC, we separate the recording into folders. Hence, NMock has for example: 
- /home/xapp/drax-version-2: These scenarios only work on dRAX version 2!
- /home/xapp/drax-version-3: These scenarios work on dRAX version 3 and 4!
- /home/xapp/drax-version-5: These scenarios only work on dRAX version 5!

# Documentation of scenarios
The explanation of the scenarios can be found in:
```
/home/xapp/explanation_of_scenarios.txt
```

# Helm Chart Configuration - values.yaml
When deploying the NMock tool, you have to prepare the values file for its Helm Chart. Most of the parameters can be left to default, except the config field. In it, you need to specify the URL where NATS and Redis for 4G and 5G are exposed. The ports are the default ports dRAX uses, hence don't need to be changed.
```
config:
  logLevel: "debug"
  natsUrl: "10.55.1.2"
  nats4gPort: "31000"
  nats5gPort: "31100"
  redisUrl: "10.55.1.2"
  redis4gPort: "32000"
  redis5gPort: "32200"
```
**NOTE:** It is enough to just create a custom-values.yaml file with only the above contents. The rest will be taken from teh default values of the Helm chart.

# Install NMock
NMock is available in the official Accelleran Helm repository. Once you prepare the values.yaml file (as described above), you can run the following command:
```
helm install nmock acc-helm/nmock --values custom-values.yaml
```

**NOTE:** Don't forget to update the Helm repository:

```
helm repo update
```

# How to run Data Simulator:
## Execute into the NMock container
Once NMock is deployed on Kubernetes, it creates a pod that does not run the NMock tool automatically, but gives you the environment to run it. Therefore, you have to execute into the pod to use the tool:
```
kubectl exec -it nmock-5c7fc75d84-n86mn -- /bin/bash
```

Of course, replace the name of the pod with the one in your deployment.

## Set up environment
Once in the NMock container, the NATS and Redis URLs and ports are saved as environmental variables in the NMock container. Hence, to support both the 4G and 5G setups, two files are autogenerated in the container:
- /home/xapp/4g-environment
- /home/xapp/5g-environment

The contents of these files are derived from the configuration values.yaml file.

One can then run the source command in the NMock container to set the proper environment depending on the technology to use: 
```
source /home/xapp/5-environment
```

## Run the /nmock tool:
An example of how to run the NMock tool:
```
nmock --force --play --repeat --file /home/xapp/drax-version-3/static-scenario/static_ue_iperf_down_up.sc2
```

Where:
- The --force option clears the Redis database and initializes it for the new scenario.
- The --play option plays back the scenario.
- The --repeat option repeats the scenario indefinitely.
- The --file option specifies the scenario .sc2 file

# Recording new scenarios
As the nmock tool can be used to record new scenarios as well, it always useful to add the ewly recorded scenario to the NMock tool. To do so:
1. Deploy the NMock tool on a setup of choosing
2. Execute into NMock
3. Set up your scenario in dRAX (cells, ues, etc.)
4. Start recording the scenario with:
```
nmock --record --force --file /home/xapp/exposed-folder/5g-my-scenario.sc2
```
5. As you can see, we save the scenario to a .sc2 file. And the file is saved in ```/home/xapp/exposed-folder/```. a couple of notes:
- The extension is our own custom .sc2
- The name of the scenario should start with a 4g- or 5g- to indicate the technology
- The name should also contain a brief description fo teh scenario (static, dynamic, etc.)
- The file is saved to the exposed folder. This means that the folder is available on the host machine in ```/opt/pods/nmock/```. This way it is easily retrievable on the host machine.

6. After the scenario is recorded, add it to NMock. This can be done by adding the files in the NMock GitHub located here: ```https://github.com/accelleran/nmock```
Place the scenario in the ```/scenarios``` folder, and then in the correct version folder.
7. Make sure to update the ```/scenarios/explanation_of_scenarios.txt``` file, to explain what your scenario looks like. Follow the same format as in the file itself.
8. Add, commit and push your changes
9. Once pushed, tag your commit. This tag will be used to build a new version of the Docker image which will be pushed to DockerHub. Check what is the latest tag in the repository. Since we are adding a new scenario, and we follow the semantic versioning, bump the minor version 0.4.0 -> 0.5.0
10. Finally, update the NMock Helm Chart to use the new version of the Docker image. You will find NMock on the master branch of the official Accelleran Helm chart GitHub: ```https://github.com/accelleran/helm-charts```. Go to the nmock folder and update the Chart.yaml file:
- appVersion: this is the tag used in the NMock GitHub. Hence, update it with the one you used to tag the new build.
- version: this is the version of the helm chart. Bump it up accordingly as well (1.0.0->1.1.0)
11. Package the new version of the NMock helm chart with:
```
helm package nmock
```
A new .tgz file will be created with a suffix of the version (not appVersion) specified in the Chart.yaml. hence it is very important to bump the version filed in Chart.yaml along with the appVersion.
12. Regenerate the index.yaml for the Helm Chart repository:
```
helm repo index . --url  https://accelleran.github.io/helm-charts/
```
NOTE: This command is specific for our Accelleran Helm Chart GitHub and Helm repo.
13. Add, commit and push the changes to the Accelleran helm chart GitHub repository. This will in turn expose the new version of NMock via the official helm chart repository.
