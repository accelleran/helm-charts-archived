apiVersion: batch/v1
kind: Job
metadata:
  name: {{ template "postgresql.primary.fullname" . }}
  annotations:
    "helm.sh/hook": pre-delete
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  template:
    spec:
      restartPolicy: OnFailure
      {{- if or (.Values.nodeSelector) (eq (tpl .Values.draxNodeSelectorEnabled .) "true") }}
      nodeSelector:
        {{ if .Values.nodeSelector }}
          {{- toYaml .Values.nodeSelector | nindent 8 }}
        {{ end }}
        {{ if eq (tpl .Values.draxNodeSelectorEnabled .) "true" }}
          {{- tpl (toYaml .Values.draxNodeSelector) $ | nindent 8 }}
        {{ end }}
      {{- end }}
      containers:
      - name: post-delete-job
        image: {{ .Values.postDeleteJob.image }}
        imagePullPolicy: {{ .Values.postDeleteJob.pullPolicy | quote }}
        command: ["kubectl"]
        args:
        - "delete"
        - "pvc"
        - "-l"
        - "app.kubernetes.io/instance={{ .Release.Name }}"
      serviceAccountName: {{ template "postgresql.primary.fullname" . }}-pvc-deleter-sa
      securityContext:
        runAsUser: 0
